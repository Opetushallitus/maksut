dist: xenial
language: java
jdk:
- openjdk11
env:
  global:
  # AWS_ACCESS_KEY_ID
  - secure: 4idEYKucxICOqzwHdAPdbLc5Ta2ipWkOLNzlStxLq1ykC3hnSHnbyyz0/XWxXgno5u99be0GcfVT8sy2/rckurPLTkqcoG71Y5QmMmAzeJSC9CKrzqzyBG15oKDovmymxyXLOmFL0+iec7sWHXe5zoC7Xz0ihJUn7CSbmKCX2OBvOktLssJiraouCEfMIJWeRBNp71Qm0rXSD3+wciRPbLcdVPXn5G558pHM6e3KZ6LgIxbFV2eWe7RCrQc6Q4Xj+I/YEMHvvA2gfsNtzU6346lb1OHwCZowPddZCXCvsJGfDEMu4EfR4Fkyl5l/UZs/YMFHjpGIzsboRseo7+zBGXv9FKHKUMljsI3VftDKx4ECjYN8BfhtKdsEDnP2jRo7Rn0XvqQSPLA1Slo4rmpyJRXUzbR3Uf/jWNKlaXpfT9Sh10TEJiNqd/hYkS6slpAEw2xfFH2eiCKhX3Ch25aqX9AiWRzJeNNcqTRk9S33SzRGMdE7nmBDkB8rpB+UFLAybvNgtnvwOwuKSxW5Q8nTpgyhUaqlh614eQMJODSo+1LmLpxAkXq+alDaI7a63KjTFZ0IO6SSIJJLRazxMl4UhfhAM8UU9u2WmREa3GeUD11MnWxKudzr1z4aRG6dkDCT1gdfvi+uCfkCVNKodPWQEhaRQw2nClj2+tCHzaqF+fQ=
  # AWS_SECRET_ACCESS_KEY
  - secure: xOGZHWjdP/Q/d7TUzIC0xJTwV2OpPMIdTH1XN2JatwIHsPb+iurobpg5HDbSGKLxVAHcPsta61JSE6oT5JPBvV7ZVBn24a/yudDo38NF86IplTLhgvIw9o1IVLkhKw7Exb8T3GrrsLudWTSvT6xX5QTv3QOE2s71bZAFBUR0dwXuOspFht+w85ZRD3V1K/AGUWnD4MNOwMfRragYcHXJz/nq5Oc6vcx3VaThw0hMWkmgMRPUyHsHbop0fh4VlDpahK1JWraFEQlu+nNcxqBwsLD3LJpoitdFkuyuu5hqLq90DKg6buKuBn+8isM2TWvE3EB/0GYSKjDdF+3HbOr0zg8wolxMAU+X04vp42Xd5vgCA13jG0hP/BrNYr1Y9xLl8VACBOkfm7fQLLOt/AoWl7txYildJenyq5+KatlpMx2kET319w82YoEmfY1xGZvfwfhGFFcV3PxRZoh6j5WBTaHsVVeGSCCS72F3ArWu2epCf/Fc+49Lh24cmYxUWpik5OI4aM2oLRfvn1VMg4r32SsznTrNm67+foz4e+4ptafrst0PpFnDlpHEUMVGvFqO1AA/1+XUvXoxacVPuHPsEhCuTxvBlysT7oDiwdsvpZ1i01VQVQ9dN2EvhCN/d7zQGEC4alyq44EEAWLcfx9WEAdpUCUJqd9WNSX471mhtoA=
cache:
  npm: true
  directories:
  - "$HOME/.m2"
  - "$HOME/.cache"
  - node_modules
install:
- git clone https://github.com/Opetushallitus/ci-tools.git
- source ci-tools/common/setup-tools.sh
script: nvm install && nvm use && npm install && ./bin/cibuild.sh run-test-nothing-for-now
  && bin/lein with-profile prod uberjar && export BASE_IMAGE="baseimage-fatjar-openjdk11:master"
  && ./ci-tools/common/pull-image.sh && cp -v ./target/maksut.jar $DOCKER_BUILD_DIR/artifact/maksut.jar
  && cp -vr ./oph-configuration $DOCKER_BUILD_DIR/config/ && ./ci-tools/build/build-fatjar.sh maksut
deploy:
  provider: script
  script: "./ci-tools/build/upload-image.sh maksut"
  on:
    all_branches: true
